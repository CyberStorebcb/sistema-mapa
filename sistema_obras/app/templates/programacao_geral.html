{% extends 'base.html' %}

{% block title %}Programação Geral - Sistema MAPA{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="container-fluid py-3 main-viewport">
    <div class="header-nav d-flex flex-wrap justify-content-between align-items-center mb-3 no-print px-3">
        <div class="d-flex align-items-center gap-3">
            <div class="brand-badge"><i class="fas fa-list-check text-info"></i></div>
            <div>
                <h5 class="text-white fw-800 mb-0">PROGRAMAÇÃO <span class="text-info">GERAL</span></h5>
                <small class="text-white-50 text-uppercase ls-1">Painel Operacional Centralizado</small>
            </div>
        </div>

        <div class="d-flex gap-3 align-items-center">
            <form id="importForm" action="{{ url_for('importar_excel') }}" method="POST" enctype="multipart/form-data" class="d-none">
                <input type="file" name="file" id="fileInput" accept=".xlsx, .xls">
            </form>
            <button type="button" class="btn-action btn-import shadow-sm" onclick="$('#fileInput').trigger('click');">
                <i class="fas fa-file-excel"></i> IMPORTAR EXCEL
            </button>
            <button type="button" class="btn-action btn-clear shadow-sm" onclick="confirmClearData()">
                <i class="fas fa-eraser"></i> LIMPAR BANCO
            </button>
        </div>
    </div>

    <div class="table-wrapper-outer shadow-lg">
        <div class="table-responsive custom-scrollbar">
            <table id="tabelaGeral" class="table table-dark table-hover mb-0">
                <thead>
                    <tr class="main-header">
                        <th class="stk-col text-center" style="z-index: 1200 !important;">
                            <span class="header-label">EQUIPE</span>
                            <div class="search-input-group" id="filter_equipe_container"></div>
                        </th>
                        <th class="text-center">
                            <span class="header-label">PEP / NOTA</span>
                            <div class="search-input-group">
                                <i class="fas fa-search"></i>
                                <input type="text" class="col-search" placeholder="Filtrar PEP">
                            </div>
                        </th>
                        <th class="text-center">
                            <span class="header-label">DATA</span>
                            <div class="search-input-group">
                                <i class="fas fa-calendar-alt"></i>
                                <input type="text" class="col-search" placeholder="Data">
                            </div>
                        </th>
                        <th class="text-center">
                            <span class="header-label">PERÍODO</span>
                            <div class="search-input-group">
                                <i class="fas fa-clock"></i>
                                <input type="text" class="col-search" placeholder="Período">
                            </div>
                        </th>
                        <th class="text-center">
                            <span class="header-label">LOCAL</span>
                            <div class="search-input-group">
                                <i class="fas fa-map-marker-alt"></i>
                                <input type="text" class="col-search" placeholder="Local">
                            </div>
                        </th>
                        <th class="text-center">
                            <span class="header-label">CONDIÇÃO</span>
                            <div class="search-input-group">
                                <i class="fas fa-tags"></i>
                                <input type="text" class="col-search" placeholder="Condição">
                            </div>
                        </th>
                        <th class="text-center">
                            <span class="header-label">OBSERVAÇÃO</span>
                            <div class="search-input-group">
                                <i class="fas fa-comment"></i>
                                <input type="text" class="col-search" placeholder="Obs">
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in projetos %}
                    <tr>
                        <td class="stk-col fw-bold text-info text-center">{{ p.equipe }}</td>
                        <td class="text-danger fw-bold font-mono text-center">{{ p.pep if p.pep and p.pep != "-" else p.nota }}</td>
                        <td class="text-white-50 text-center">{{ p.data }}</td>
                        <td class="text-center">
                            <span class="period-badge {% if 'MANHÃ' in p.periodo|upper %}morn{% elif 'TARDE' in p.periodo|upper %}aft{% else %}full{% endif %}">
                                {{ p.periodo }}
                            </span>
                        </td>
                        <td class="small text-center px-3" style="min-width: 200px;">{{ p.local }}</td>
                        <td class="text-center"><span class="cond-badge">{{ p.condicao }}</span></td>
                        <td class="text-muted small italic text-center">{{ p.obs }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    :root { 
        --bg-main: #0d1117; 
        --bg-card: #161b22; 
        --bg-header: #1f242c; 
        --accent: #58a6ff; 
        --border: #30363d; 
    }

    /* CSS para fixar a barra de rolagem no fundo do ecrã */
    body { 
        background-color: var(--bg-main); 
        color: #c9d1d9; 
        font-family: 'Inter', sans-serif; 
        margin: 0; 
        padding: 0;
        height: 100vh; 
        overflow: hidden; /* Impede scroll no body */
    }

    .main-viewport { 
        height: 100vh; 
        display: flex; 
        flex-direction: column; 
        padding: 15px;
    }

    .table-wrapper-outer { 
        flex-grow: 1; 
        background: var(--bg-card); 
        border: 1px solid var(--border); 
        border-radius: 12px; 
        overflow: hidden; 
        display: flex;
        flex-direction: column;
        min-height: 0; /* Importante para flexbox */
    }

    .table-responsive { 
        flex-grow: 1;
        overflow: auto !important; 
        position: relative;
    }

    /* Estilização da Tabela */
    .table-dark { border-collapse: separate; border-spacing: 0; width: 100%; margin: 0; }
    
    .main-header th {
        position: sticky; top: 0; z-index: 1000;
        background: var(--bg-header) !important;
        color: var(--accent) !important;
        font-size: 0.70rem; padding: 12px 8px !important;
        border-bottom: 2px solid var(--border) !important;
    }

    .stk-col {
        position: sticky; left: 0; z-index: 900;
        background: #1c2128 !important;
        min-width: 180px;
        border-right: 3px solid var(--accent) !important;
    }

    /* Filtros Uniformizados */
    .search-input-group { position: relative; display: flex; align-items: center; width: 100%; height: 32px; margin-top: 5px; }
    .search-input-group i { position: absolute; left: 10px; font-size: 0.70rem; color: #484f58; z-index: 10; }
    
    .col-search, .col-select {
        width: 100%; height: 100% !important;
        background: var(--bg-main) !important;
        border: 1px solid var(--border) !important;
        border-radius: 6px; color: white !important;
        font-size: 0.70rem !important; padding: 0 8px 0 28px !important;
        text-align: center;
    }

    .col-select { padding: 0 20px 0 10px !important; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%2358a6ff' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; }

    /* Badges e Células */
    tbody td { padding: 10px 8px !important; border-bottom: 1px solid var(--border) !important; vertical-align: middle !important; font-size: 0.85rem; }
    .period-badge { display: inline-block; min-width: 80px; padding: 3px 8px; border-radius: 5px; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; }
    .period-badge.morn { background: #f2cc60; color: #412d00; }
    .period-badge.aft { background: #388bfd; color: #fff; }
    .period-badge.full { background: #238636; color: #fff; }

    /* Barra de Rolagem Personalizada (Estilo MAPA) */
    .custom-scrollbar::-webkit-scrollbar { height: 10px; width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: var(--bg-main); }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #30363d; border-radius: 10px; border: 2px solid var(--bg-main); }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: var(--accent); }

    /* Botões */
    .btn-action { border: none; padding: 8px 16px; border-radius: 6px; font-weight: 700; font-size: 0.75rem; transition: 0.2s; }
    .btn-import { background: var(--accent); color: #fff; }
    .btn-clear { background: #da3633; color: #fff; }
</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
    $(document).ready(function() {
        var table = $('#tabelaGeral').DataTable({
            "language": { "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json" },
            "pageLength": 100,
            "dom": 'rt<"d-flex justify-content-between align-items-center px-3 py-2"ip>',
            "ordering": true,
            "initComplete": function () {
                this.api().column(0).every(function () {
                    var column = this;
                    var select = $('<select class="col-select"><option value="">TODAS</option></select>')
                        .appendTo('#filter_equipe_container')
                        .on('change', function () {
                            var val = $.fn.dataTable.util.escapeRegex($(this).val());
                            column.search(val ? '^' + val + '$' : '', true, false).draw();
                        });
                    column.data().unique().sort().each(function (d) {
                        if(d) select.append('<option value="' + d + '">' + d + '</option>');
                    });
                });
            }
        });

        $('.col-search').on('keyup change', function() {
            var colIndex = $(this).closest('th').index();
            table.column(colIndex).search(this.value).draw();
        });

        $('#fileInput').on('change', function() {
            if (this.files.length > 0) $('#importForm').submit();
        });
    });

    function confirmClearData() {
        if (confirm('⚠️ Tem certeza que deseja apagar todos os dados?')) {
            window.location.href = "{{ url_for('limpar_dados') }}";
        }
    }
</script>
{% endblock %}